<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Full Simulation</title>
  <meta name="description" content="Main page for documentation and resources.">

  <link rel="stylesheet" href="http://fccsw.web.cern.ch/fccsw/css/main.css">
  <link rel="canonical" href="http://fccsw.web.cern.ch/fccsw/tutorials/FCCSW/Sim/doc/FullSimulation.html">
  <link rel="alternate" type="application/rss+xml" title="FCCSW" href="http://fccsw.web.cern.ch/fccsw/feed.xml">
</head>


  <body>

    
<header>
   <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://fccsw.web.cern.ch/fccsw/index.html">FCCSW</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="http://fccsw.web.cern.ch/fccsw/index.html">Home</a></li>
            <li  class="active" ><a href="http://fccsw.web.cern.ch/fccsw/tutorials">Tutorials</a></li>
            <li><a>Latest Releases:</a></li>
            
            
              
              <li >
                <a href="http://fccsw.web.cern.ch/fccsw/2017/05/15/version081.html">FCCSW v0.8.1</a>
              </li>
              
            
              
              <li >
                <a href="http://fccsw.web.cern.ch/fccsw/2017/03/29/version08.html">FCCSW v0.8</a>
              </li>
              
            
            <li ><a href="http://fccsw.web.cern.ch/fccsw/snapshot.html">Snapshot</a></li>
          </ul>
          <form class="navbar-form navbar-right">
            <div class="input-group">
            <span class="input-group-addon" id="basic-addon1"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></span>
            <input type="text" class="form-control" id="search-input" placeholder="Search" aria-describedby="basic-addon1">
            </div>
          </form>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

</header>
<div class="container">
  <div class="collapse panel panel-default" id="resultswrap">
      <div class="panel-heading">Search Results <button type="button" class="close" aria-label="Close"><span aria-hidden="true" onclick="$('#resultswrap').collapse('hide');">&times;</span></button></div>
      <ul id="searchresults" class="list-group">
      </ul>
  </div>
</div>

    
    
    <div class="container">
      <div class="col-md-10">
        <h1 id="full-simulation-with-geant4-in-fccsw">Full Simulation with Geant4 in FCCSW</h1>

<p>Instruction how to use Geant4 within FCCSW (GAUDI framework).</p>

<p>For additional information on fast simulation in Geant4 <a href="FastSimulationUsingGeant.html">see</a>.</p>

<blockquote>
  <p>All relative paths refer to the main FCCSW directory.</p>
</blockquote>

<h2 id="contents">Contents</h2>
<p><a href="#overview">Overview</a>
  * <a href="#geant-components">Geant</a>
  * <a href="#simulation-package-in-fccsw">Sim package in FCCSW</a>
<a href="#example">Example of full sim configuration</a>
<a href="#geant-configuration-via-gaudi-service-simg4svc">Geant configuration via GAUDI service <code class="highlighter-rouge">SimG4Svc</code></a>
  * <a href="#geometry-construction">Geometry construction</a>
  * <a href="#physics-list">Physics list</a>
  * <a href="#user-actions">User actions</a>
<a href="#simulation-in-gaudi-algorithm-simg4alg">Simulation in GAUDI algorithm <code class="highlighter-rouge">SimG4Alg</code></a>
  * <a href="#event-processing">Events</a>
  * <a href="#output">Output</a>
<a href="#units">Units</a></p>

<h2 id="how-to">How to</h2>
<ul>
  <li><a href="#sensitive-detectors">use sensitive detectors</a></li>
  <li><a href="#how-to-use-different-physics-list">change the physics list</a></li>
  <li><a href="#how-to-add-a-user-action">add user action</a></li>
  <li><a href="FastSimulationUsingGeant.html">use fast simulation</a></li>
</ul>

<h2 id="overview">Overview</h2>

<h3 id="geant-components">Geant components</h3>

<p>Geant main manager class is <code class="highlighter-rouge">G4RunManager</code>. It has own implementation in FCCSW <code class="highlighter-rouge">sim::RunManager</code> as the event flow is governed by GAUDI and not by Geant.</p>

<h4 id="main-service-simg4svc-see-moregeant-configuration-via-gaudi-service-simg4svc">Main service <code class="highlighter-rouge">SimG4Svc</code> (<a href="#geant-configuration-via-gaudi-service-simg4svc">see more</a>)</h4>

<p>The main simulation service <code class="highlighter-rouge">SimG4Svc</code> owns <code class="highlighter-rouge">sim::RunManager</code> and controls the communication between GAUDI and Geant (<code class="highlighter-rouge">sim::RunManager</code>).</p>

<p>Necessary information about the simulation that needs to be given:
* detector geometry (<code class="highlighter-rouge">ISimG4DetectorConstruction</code> tool)
* physics list describing all the particles that can be created in the simulation and all the processes they may encounter (<code class="highlighter-rouge">ISimG4PhysicsList</code> tool)
* additional requirements (so-called user actions) (<code class="highlighter-rouge">ISimG4ActionTool</code>)</p>

<p>This service is also passing events (<code class="highlighter-rouge">G4Event</code>) to and from Geant.</p>

<h4 id="main-algorithm-simg4alg-see-moresimulation-in-gaudi-algorithm-simg4alg">Main algorithm <code class="highlighter-rouge">SimG4Alg</code> (<a href="#simulation-in-gaudi-algorithm-simg4alg">see more</a>)</h4>

<p>The main simulation algorithm communicates with <code class="highlighter-rouge">SimG4Svc</code> in each event loop execution.
It is responsible for creation of a <code class="highlighter-rouge">G4Event</code> (by default: translation from the EDM event), passing it to the service for the simulation and retrieving it afterwards.</p>

<p>Retrieved <code class="highlighter-rouge">G4Event</code> contains the very same primary particles and vertices, though it also contains hits collections and <a href="#simulation-in-gaudi-algorithm-simg4alg">various information</a>. To enable a flexible setting of what should be saved from an event, it may be specified in a tool derived from <code class="highlighter-rouge">ISimG4SaveOutputTool</code>.
A property <strong>outputs</strong> of <code class="highlighter-rouge">SimG4Alg</code> takes a list of strings with those tool names.
Those tools should declare the output that can be further stored by the algorithm <code class="highlighter-rouge">PodioOutput</code>.</p>

<h3 id="simulation-package-in-fccsw">Simulation package in FCCSW</h3>

<p>Simulation package contains following directories:</p>

<ul>
  <li><em>SimG4Interfaces</em>
    <ul>
      <li>interfaces to tools, algorithms and services;</li>
    </ul>
  </li>
  <li><em>SimG4Components</em>
    <ul>
      <li>all main components (e.g. <code class="highlighter-rouge">SimG4Svc</code>, <code class="highlighter-rouge">SimG4DD4hepDetector</code>)</li>
      <li>tests, further examples (e.g. <code class="highlighter-rouge">Sim/SimG4Components/tests/geant_fullsim_hcal.py</code>)</li>
    </ul>
  </li>
  <li><em>SimG4Common</em>
    <ul>
      <li>Geant classes’ implementations, common for both the full and fast simulation (e.g. <code class="highlighter-rouge">sim::RunManager</code>)</li>
    </ul>
  </li>
  <li><em>SimG4Full</em>
    <ul>
      <li>components and Geant classes’ implementations used in the full simulation (e.g. <code class="highlighter-rouge">SimG4FullSimActions</code>)</li>
    </ul>
  </li>
  <li><em>SimG4Fast</em>
    <ul>
      <li>components and Geant classes’ implementations used in the fast simulation (e.g. <code class="highlighter-rouge">sim::FastSimPhysics</code>)</li>
    </ul>
  </li>
</ul>

<h2 id="example">Example</h2>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>./run gaudirun.py Examples/options/geant_fullsim.py
</code></pre>
</div>

<p>The configuration file (<code class="highlighter-rouge">Examples/options/geant_fullsim.py</code>) contains:
  * reading an event from a HepMC file</p>

<div class="highlighter-rouge"><pre class="highlight"><code>~~~python
from Configurables import HepMCFileReader, GenAlg
readertool = HepMCFileReader("ReaderTool", Filename="/eos/project/f/fccsw-web/testsamples/FCC_minbias_100TeV.dat")
reader = GenAlg("Reader", SignalProvider=readertool)
reader.hepmc.Path = "hepmc"
~~~
</code></pre>
</div>

<ul>
  <li>
    <p>translating a HepMC event to the EDM</p>

    <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Configurables</span> <span class="kn">import</span> <span class="n">HepMCConverter</span>
<span class="n">hepmc_converter</span> <span class="o">=</span> <span class="n">HepMCConverter</span><span class="p">(</span><span class="s">"Converter"</span><span class="p">)</span>
<span class="n">hepmc_converter</span><span class="o">.</span><span class="n">hepmc</span><span class="o">.</span><span class="n">Path</span><span class="o">=</span><span class="s">"hepmc"</span>
<span class="n">hepmc_converter</span><span class="o">.</span><span class="n">genparticles</span><span class="o">.</span><span class="n">Path</span><span class="o">=</span><span class="s">"allGenParticles"</span>
<span class="n">hepmc_converter</span><span class="o">.</span><span class="n">genvertices</span><span class="o">.</span><span class="n">Path</span><span class="o">=</span><span class="s">"allGenVertices"</span>
</code></pre>
    </div>
  </li>
  <li>construction of the geometry using DD4hep
    <ul>
      <li><code class="highlighter-rouge">detectors</code> - paths to the XML files with geometry (master file with dimensions and an example: tracker)</li>
    </ul>

    <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Configurables</span> <span class="kn">import</span> <span class="n">GeoSvc</span>
<span class="n">geoservice</span> <span class="o">=</span> <span class="n">GeoSvc</span><span class="p">(</span><span class="s">"GeoSvc"</span><span class="p">,</span>
                     <span class="n">detectors</span><span class="o">=</span><span class="p">[</span><span class="s">'file:Detector/DetFCChhBaseline1/compact/FCChh_DectEmptyMaster.xml'</span><span class="p">,</span>
                     <span class="s">'file:Detector/DetFCChhTrackerTkLayout/compact/Tracker.xml'</span><span class="p">])</span>
</code></pre>
    </div>
  </li>
  <li>Geant configuration (<a href="#geant-configuration-via-gaudi-service-simg4svc">see more</a>)
    <ul>
      <li><strong>detector</strong> - tool providing the <a href="#geometry-construction">geometry</a>, possible: SimG4DD4hepDetector (default) and <a href="#gdml-example">SimG4GdmlDetector</a></li>
      <li><strong>physicslist</strong> - tool providing the <a href="#physics-list">physics list</a>, possible: SimG4FtfpBert(default)</li>
      <li><strong>actions</strong> - tool providing the <a href="#user-actions">user actions initialisation list</a>, possible: SimG4FullSimActions(default)
~~~python
from Configurables import SimG4Svc
geantservice = SimG4Svc(“SimG4Svc”,
                       detector=’SimG4DD4hepDetector’,
                       physicslist=”SimG4FtfpBert”,
                       actions=”SimG4FullSimActions” )
~~~</li>
    </ul>
  </li>
  <li>simulation (<a href="#simulation-in-gaudi-algorithm-simg4alg">see more</a>)
    <ul>
      <li><code class="highlighter-rouge">outputs</code> - names of the tools saving the <a href="#output">output</a> from a simulated event,
possible: <code class="highlighter-rouge">SimG4SaveTrackerHits</code>, <code class="highlighter-rouge">SimG4SaveCalHits</code></li>
      <li><code class="highlighter-rouge">eventProvider</code> - tool that provides <code class="highlighter-rouge">G4Event</code> to the simulation, possible <code class="highlighter-rouge">SimG4PrimariesFromEdmTool</code>, <code class="highlighter-rouge">SimG4SingleParticleGeneratorTool</code></li>
    </ul>

    <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Configurables</span> <span class="kn">import</span> <span class="n">SimG4Alg</span><span class="p">,</span> <span class="n">SimG4SaveTrackerHits</span><span class="p">,</span> <span class="n">SimG4PrimariesFromEdmTool</span>
<span class="n">savetrackertool</span> <span class="o">=</span> <span class="n">SimG4SaveTrackerHits</span><span class="p">(</span><span class="s">"SimG4SaveTrackerHits"</span><span class="p">,</span> <span class="n">readoutNames</span> <span class="o">=</span> <span class="p">[</span><span class="s">"TrackerBarrelReadout"</span><span class="p">,</span> <span class="s">"TrackerEndcapReadout"</span><span class="p">])</span>
<span class="n">savetrackertool</span><span class="o">.</span><span class="n">positionedTrackHits</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="s">"positionedHits"</span>
<span class="n">savetrackertool</span><span class="o">.</span><span class="n">trackHits</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="s">"hits"</span>
<span class="n">particle_converter</span> <span class="o">=</span> <span class="n">SimG4PrimariesFromEdmTool</span><span class="p">(</span><span class="s">"EdmConverter"</span><span class="p">)</span>
<span class="n">particle_converter</span><span class="o">.</span><span class="n">genParticles</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="s">"allGenParticles"</span>
<span class="n">geantsim</span> <span class="o">=</span> <span class="n">SimG4Alg</span><span class="p">(</span><span class="s">"SimG4Alg"</span><span class="p">,</span>
                     <span class="n">outputs</span><span class="o">=</span> <span class="p">[</span><span class="s">"SimG4SaveTrackerHits/SimG4SaveTrackerHits"</span><span class="p">],</span>
                     <span class="n">eventProvider</span><span class="o">=</span><span class="n">particle_converter</span><span class="p">)</span>
</code></pre>
    </div>
  </li>
  <li>saving the output to ROOT file
    <ul>
      <li><code class="highlighter-rouge">reaodouts</code> property of saving tool (in the example above <code class="highlighter-rouge">SimG4SaveTrackerHits</code>) defines for which readoutNames the hits collections should be translated to EDM. Readout name is defined in DD4hep XML file as the attribute <code class="highlighter-rouge">readout</code> of <code class="highlighter-rouge">detector</code> tag.</li>
    </ul>

    <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Configurables</span> <span class="kn">import</span> <span class="n">PodioOutput</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">PodioOutput</span><span class="p">(</span><span class="s">"out"</span><span class="p">,</span>
                   <span class="n">OutputLevel</span><span class="o">=</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">out</span><span class="o">.</span><span class="n">outputCommands</span> <span class="o">=</span> <span class="p">[</span><span class="s">"keep *"</span><span class="p">]</span>
</code></pre>
    </div>
  </li>
  <li>GAUDI’s main component
    <ul>
      <li>stating which algorithms (<code class="highlighter-rouge">TopAlg</code>) should be initialised, executed and finalised in the event loop</li>
      <li>specifying how many events from the input file should be processed (<code class="highlighter-rouge">EvtMax</code>)</li>
      <li>stating which services (<code class="highlighter-rouge">ExtSvc</code>) should be created at initialisation</li>
      <li>output level (<code class="highlighter-rouge">OutputLevel</code>), possible: VERBOSE, DEBUG, INFO, WARNING, ERROR, FATAL, ALWAYS</li>
    </ul>

    <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Configurables</span> <span class="kn">import</span> <span class="n">ApplicationMgr</span>
<span class="n">ApplicationMgr</span><span class="p">(</span> <span class="n">TopAlg</span> <span class="o">=</span> <span class="p">[</span><span class="n">reader</span><span class="p">,</span> <span class="n">hepmc_converter</span><span class="p">,</span> <span class="n">geantsim</span><span class="p">,</span> <span class="n">out</span><span class="p">],</span>
<span class="n">EvtSel</span> <span class="o">=</span> <span class="s">'NONE'</span><span class="p">,</span>
<span class="n">EvtMax</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="n">ExtSvc</span> <span class="o">=</span> <span class="p">[</span><span class="n">podioevent</span><span class="p">,</span> <span class="n">geoservice</span><span class="p">,</span> <span class="n">geantservice</span><span class="p">],</span> <span class="c"># order! geo needed by geant</span>
<span class="n">OutputLevel</span> <span class="o">=</span> <span class="n">DEBUG</span>
<span class="p">)</span>
</code></pre>
    </div>
  </li>
</ul>

<h4 id="other-examples">Other examples</h4>
<p>Another examples of the simulation (different detectors, event generators) can be found in:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Examples/options/
Sim/SimG4Components/tests/options/
</code></pre>
</div>

<h4 id="gdml-example">GDML example</h4>
<p>There is a possibility to create the detector with GDML instead of DD4hep. In this case, however, no sensitive detectors are predefined and user is responsible for their implementation. Preferable hit format is the one used by DD4hep (e.g. <code class="highlighter-rouge">DD4hep::Simulation::Geant4CalorimeterHit</code>), this way user may use the saving output utilities that are already provided.
Simple example:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>./run gaudirun.py Sim/SimG4Components/tests/options/geant_fullsim_gdml.py
</code></pre>
</div>

<h2 id="geant-configuration-via-gaudi-service-simg4svc">Geant configuration: via GAUDI service SimG4Svc</h2>

<p>Main service for simulation with Geant4 <code class="highlighter-rouge">SimG4Svc</code> owns <code class="highlighter-rouge">sim::RunManager</code> which derives from <code class="highlighter-rouge">G4RunManager</code>. Own implementation of G4RunManager was necessary in order to leave the event flow to GAUDI. All the details that does not concern the particle generator remain the same. Consult Geant4 <a href="http://geant4.web.cern.ch/geant4/UserDocumentation/UsersGuides/ForToolkitDeveloper/html/index.html">User’s Guide</a> or <a href="http://geant4.web.cern.ch/geant4/UserDocumentation/UsersGuides/PhysicsReferenceManual/fo/PhysicsReferenceManual.pdf">Physics Manual</a> for more details.</p>

<p>In particular, there are two basic ingredients of the simulation: geometry that describes what is the material in which particle is propagated, and a so-called physics list that contains all the particles that may be created in the simulation together with an associated list of physics processes they may encounter.</p>

<p>The general concept of the simulation in Geant is to divide each simulation ‘stage’ into smaller pieces until the smallest (and simplest) is reached. The most overall is <strong>run</strong> which is a set of <strong>events</strong>. Each event consists of primary particles that are represented by <strong>tracks</strong>. Each track in a simulation is a <strong>step</strong>-by-step analysis of a particle passage through matter. Geant toolkit leaves a user the possibility to monitor the simulation at any of those stages. Hence, the so-called user actions may be created that undertake user-specified action before/at/after certain stage.</p>

<p>Any communication with the Geant Run Manager is handled by this service:
- configuration:
  - <a href="#geometry-construction">geometry construction</a>
  - <a href="#physics-list">physics list initialisation</a>
  - <a href="#user-actions">user actions initialisation</a>
- simulation:
  - <a href="#event-processing">passing an event to <code class="highlighter-rouge">G4EventManager</code></a>
  - <a href="#output">retrieving a simulated event (with hits collections and other information)</a></p>

<h3 id="geometry-construction">Geometry construction</h3>

<blockquote>
  <p>Consult <a href="../../Detector/doc/DD4hepInFCCSW.html">detector documentation in FCCSW</a> and <a href="http://aidasoft.web.cern.ch/DD4hep" title="DD4hep user manuals">DD4hep user guides</a> for more details.</p>
</blockquote>

<p>FCCSW is using Detector Description for HEP (DD4hep) toolkit.</p>

<p>DD4hep is able to parse automatically the geometry and convert it to Geant4 format. It can be retrieved and passed to the Geant configuration service via tool <code class="highlighter-rouge">SimG4DD4hepDetector</code>. User does not need to set the geometry tool in <code class="highlighter-rouge">SimG4Svc</code> as it is by default set to <code class="highlighter-rouge">SimG4DD4hepDetector</code>. Only <code class="highlighter-rouge">GeoSvc</code> needs to be configured.</p>

<p>FCCSW provides an alternative way to create the geometry, via GDML description (and tool <code class="highlighter-rouge">SimG4GdmlDetector</code> with property <strong>gdml</strong> taking a path to the GDML file). It is meant only for the test purposes as it does not support sensitive detectors. User would need to create them on his own. See more in the <a href="#gdml-example">example</a>.</p>

<h3 id="sensitive-detectors">Sensitive detectors</h3>

<p>Sensitive detectors are responsible for creating the hits whenever a particle traverses the active material. The readout of each detector can be described in DD4hep.
(see more in <a href="../../Detector/doc/DD4hepInFCCSW.html#sensitive-detectors">Detector documentation</a>)</p>

<ul>
  <li>XML file should contain:
    <ul>
      <li>readout structure, a structure of a sensitive volume <code class="highlighter-rouge">&lt;readout&gt;</code></li>
      <li>information on how each sensitive element is segmented <code class="highlighter-rouge">&lt;segmentation&gt;</code></li>
      <li>unique identification of the location of each response <code class="highlighter-rouge">&lt;id&gt;</code></li>
    </ul>

    <div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;readouts&gt;</span>
  <span class="nt">&lt;readout</span> <span class="na">name=</span><span class="s">"BarHCal_Readout"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;segmentation</span> <span class="na">type=</span><span class="s">"CartesianGridXY"</span> <span class="na">grid_size_x=</span><span class="s">"0.05*mm"</span> <span class="na">grid_size_y=</span><span class="s">"0.05*mm"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;id&gt;</span>system:3,layer:10,wedge:7,sub_module:2,row:9,x:32:-16,y:-16<span class="nt">&lt;/id&gt;</span>
  <span class="nt">&lt;/readout&gt;</span>
<span class="nt">&lt;/readouts&gt;</span>
</code></pre>
    </div>
    <blockquote>
      <h4 id="note">Note:</h4>
      <p>Names of the readouts are also names of the collections of hits from that readout. They are used further in the implementations if <code class="highlighter-rouge">ISimG4SaveOutputTool</code> that retrieve the hits from Geant and store them in the EDM.</p>
    </blockquote>
  </li>
  <li>C++ factory method should:
    <ul>
      <li>construct all the sub-volumes of the detector (extracting detail information e.g. on number of layers, modules in z direction or in phi, their material, etc. from the XML file)</li>
      <li>
        <p>set the sensitive detector type</p>

        <div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">DD4hep</span><span class="o">::</span><span class="n">Geometry</span><span class="o">::</span><span class="n">SensitiveDetector</span><span class="o">::</span><span class="n">setType</span><span class="p">(</span><span class="s">"SimpleCalorimeterSD"</span><span class="p">);</span>
</code></pre>
        </div>

        <p>This way the hits collection are created automatically and are filled whenever a particle traverses a sensitive material. Hits are be stored in either <code class="highlighter-rouge">DD4hep::Simulation::Geant4TrackerHit</code> or <code class="highlighter-rouge">DD4hep::Simulation::Geant4CalorimeterHit</code>. See more on the current implementations of the sensitive detector types in the <a href="../../Detector/doc/DD4hepInFCCSW.html#using-an-existing-sensitive-detector-definition">Detector documentation</a>.</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="physics-list">Physics List</h3>

<p>Physics list describes all the particles and physics processes used in the simulation.</p>

<p>Physics list tool can be set as <strong>physicslist</strong> property of <code class="highlighter-rouge">SimG4Svc</code>. If none is set, the default list is used (FTFP_BERT).</p>

<p>Currently used physics list is FTFP_BERT, which is recommended by Geant4 for HEP studies. The tool that creates this list is called <code class="highlighter-rouge">SimG4FtfpBert</code> (it simply creates <code class="highlighter-rouge">G4VModularPhysicsList</code> that can be set in <code class="highlighter-rouge">sim::RunManager</code> by <code class="highlighter-rouge">SimG4Svc</code>).</p>

<p>List of other reference physics list may be found <a href="http://geant4.cern.ch/geant4/support/proc_mod_catalog/physics_lists/referencePL.shtml">here</a></p>

<h3 id="how-to-use-different-physics-list">How to use different physics list</h3>
<p>In order to use a different physics list, one needs to construct a physics list tool basing on <code class="highlighter-rouge">SimG4FtfpBert</code> tool.</p>

<p>Any new implementation of a physics list (or any other component) should be presented in a pull request to HEP-FCC/FCCSW.</p>

<h3 id="user-actions">User Actions</h3>

<p>User actions tool can be added as a property <strong>actions</strong> to <code class="highlighter-rouge">SimG4Svc</code>. If none is set, the default action initialization is used (currently empty - no default actions are specified).</p>

<p>Geant allows users to specify what should be performed at any stage of simulation.
User actions are created in the implementation of <code class="highlighter-rouge">GVUserActionInitialization</code> class, e.g. <code class="highlighter-rouge">sim::FullSimActions::Build()</code>.
Any implementation of action initialisation list should have a relevant GAUDI component (tool) that creates it. Tool creating <code class="highlighter-rouge">sim::FullSimActions</code> is called <code class="highlighter-rouge">SimG4FullSimActions</code>.</p>

<p>Currently <code class="highlighter-rouge">sim::FullSimActions</code> is empty and no user actions are created.</p>

<p>User actions may derive from the following G4 interfaces:
* G4UserRunAction
* G4UserEventAction
* G4UserStackingAction
* G4UserTrackingAction
* G4UserSteppingAction
* G4UserTimeStepAction</p>

<h3 id="how-to-add-a-user-action">How to add a user action</h3>

<p>Any user action that derives from Geant4 interface can be implemented in <code class="highlighter-rouge">Sim/SimG4Full/</code> subpackage.</p>

<p>In order to invoke this action in the simulation, it should be created in the <code class="highlighter-rouge">sim::FullSimActions::Build()</code> method.</p>

<p>Different ‘sets’ of user actions can be created in other implementations of <code class="highlighter-rouge">G4VUserActionInitialization</code>.
In that case, a relevant GAUDI tool should be created, basing on <code class="highlighter-rouge">SimG4FullSimActions</code>. Its name should follow the convention of adding a prefix “SimG4” to the name of the class (implementation of <code class="highlighter-rouge">G4VUserActionInitialization</code> that it creates).</p>

<h2 id="simulation-in-gaudi-algorithm-simg4alg">Simulation in GAUDI algorithm SimG4Alg</h2>

<p>Simulation algorithm handles all the communication between other algorithms and <code class="highlighter-rouge">SimG4Svc</code>.</p>

<p>It takes as input <strong>eventProvider</strong> tool that passes <code class="highlighter-rouge">G4Event</code>, either translated from EDM and <code class="highlighter-rouge">MCParticleCollection</code> (<code class="highlighter-rouge">SimG4PrimariesFromEdmTool</code>), or from the Geant4 particle gun (<code class="highlighter-rouge">SimG4SingleParticleGeneratorTool</code>).</p>

<p>Also, a list of names to the output-saving tools can be specified in <strong>outputs</strong>.</p>

<h3 id="event-processing">Event Processing</h3>

<p>For each execution of the algorithm an event <code class="highlighter-rouge">G4Event</code> is retrieved from the <strong>eventProvider</strong> tool. <code class="highlighter-rouge">G4Event</code> is passed to <code class="highlighter-rouge">SimG4Svc</code> and after the simulation is done, it is retrieved. Here all (if any) saving tools are called. Finally, an event is terminated.</p>

<h3 id="output">Output</h3>

<p>Saving the output from a simulated <code class="highlighter-rouge">G4Event</code> is performed by tools deriving from an interface <code class="highlighter-rouge">ISimG4SaveOutputTool</code>.
Tools should have the data outputs specified.
A method <code class="highlighter-rouge">ISimG4SaveOutputTool::SaveOutput(...)</code> is meant to retrieve any useful information and save it to EDM.
Useful information means e.g. hits collections (<code class="highlighter-rouge">G4HCofThisEvent</code>) or anything stored in an implementation of <code class="highlighter-rouge">G4VUserEventInformation</code>, <code class="highlighter-rouge">G4VUserEventInformation</code>, <code class="highlighter-rouge">G4VUserTrackInformation</code>, <code class="highlighter-rouge">G4VUserPrimaryParticleInformation</code> etc.</p>

<p>Existing tools store hits collections from the tracker detectors (<code class="highlighter-rouge">SimG4SaveTrackerHits</code>) or calorimeters (<code class="highlighter-rouge">SimG4SaveCalHits</code>). The names of the hits collections are passed to the saving tool in property <strong>readoutNames</strong>. The name of the readout is defined in DD4hep XML file as the attribute <code class="highlighter-rouge">readout</code> of <code class="highlighter-rouge">&lt;detector&gt;</code> tag and also under the <code class="highlighter-rouge">&lt;readout&gt;</code> tag. For instance, the collection below contains hits in the tracker (“CentralTracker_Readout”) (<a href="#sensitive-detectors">see more</a>). If vector <strong>readoutNames</strong> contains no elements or any name that does not correspond to the hit collection, the tool will fail at initialization.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;readouts&gt;</span>
  <span class="nt">&lt;readout</span> <span class="na">name=</span><span class="s">"CentralTracker_Readout"</span><span class="nt">&gt;</span>
  ...
  <span class="nt">&lt;/readout&gt;</span>
<span class="nt">&lt;/readouts&gt;</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">SimG4SaveTrackerHits</code> stores <strong>trackHits</strong> (EDM <code class="highlighter-rouge">TrackHitCollection</code>) and <strong>positionedTrackHits</strong> (EDM <code class="highlighter-rouge">PositionedTrackHitCollection</code>).
<code class="highlighter-rouge">SimG4SaveCalHits</code> tool can be used for the hit collections from both the electromagetic and hadronic calorimeters. It stores <strong>caloHits</strong> (EDM <code class="highlighter-rouge">CaloHitCollection</code>) and <strong>positionedCaloHits</strong> (EDM <code class="highlighter-rouge">PositionedCaloHitCollection</code>).</p>

<p>Positioned hits contain not only the information about the hit, but also the exact position of each energy deposit. If that information is not required by the study, it can be dropped before saving to the output file (by setting in the algorithm <code class="highlighter-rouge">PodioOutput</code> the property <strong>outputCommands</strong> to e.g. [‘keep *’, ‘drop positionedHits’]).</p>

<h3 id="units">Units</h3>

<p>Important aspect of the translations between HepMC, EDM and Geant4 are the units. Since each framework uses by default different units, every translation should take that into account.</p>

<p>Conversions between EDM and Geant4 are specified in <code class="highlighter-rouge">sim::Units</code>.</p>

<p>Conversions between EDM and HepMC depend on the units used by HepMC input file (changes from file to file) and is therefore handled separately in HepMCConverter class.</p>

      </div>
      <div class="col-md-2">    <ul class="list-group">
        <li class="list-group-header">
            <h4>External links</h4>
        </li>
        
            <li class="list-group-item">
                <a href='http://cern.ch/simba3/SelfSubscription.aspx?groupName=fcc-experiments-sw-dev'>FCCSW Mailing list</a>
            </li>
        
            <li class="list-group-item">
                <a href='http://fccsw.web.cern.ch/fccsw/tutorials/'>FCCSW Tutorials</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/fccsw/issues'>FCCSW Issue Tracker</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/'>FCCSW on GitHub</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://phsft-jenkins.cern.ch/view/FCC/'>FCCSW Jenkins</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/FCCSW/blob/master/doc/CppCodingStyleGuidelines.md'>FCCSW C++ Style Guide</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/FCCSW/blob/master/doc/GeneralCppGuidelines.md'>General C++ Guidelines</a>
            </li>
        
    </ul>
</div>
    </div>
    <script src="http://fccsw.web.cern.ch/fccsw/node_modules/jquery/dist/jquery.min.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/bootstrap-sass/assets/javascripts/bootstrap.min.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/requirejs/require.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/simple-jekyll-search/dest/simple-jekyll-search.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/javascript">
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('searchresults'),
        json: 'http://fccsw.web.cern.ch/fccsw/search.json',
        searchResultTemplate: '<li class="list-group-item"><a href="{url}" title="{desc}">{title}</a></li>',
        noResultsText: '<li class="list-group-item">No results found</li>',
        limit: 10,
        fuzzy: false,
        exclude: ['Welcome']
      });
      $("#search-input").keypress(function() {
            $("#resultswrap").collapse('show');
      });
      $("#search-input").keyup(function() {
            if ($(this).val() == "") {
                $("#resultswrap").collapse('hide');
            }
      });
      $("table").each(function(index) {
        $(this).addClass("table");
      });
    </script>


  </body>
</html>
