<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Adding Tests To FCCSW</title>
  <meta name="description" content="Main page for documentation and resources.">

  <link rel="stylesheet" href="http://fccsw.web.cern.ch/fccsw/css/main.css">
  <link rel="canonical" href="http://fccsw.web.cern.ch/fccsw/tutorials/FCCSW/doc/AddingTestsToFCCSW.html">
  <link rel="alternate" type="application/rss+xml" title="FCCSW" href="http://fccsw.web.cern.ch/fccsw/feed.xml">
</head>


  <body>

    
<header>
   <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://fccsw.web.cern.ch/fccsw/index.html">FCCSW</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="http://fccsw.web.cern.ch/fccsw/index.html">Home</a></li>
            <li  class="active" ><a href="http://fccsw.web.cern.ch/fccsw/tutorials">Tutorials</a></li>
            <li><a>Latest Releases:</a></li>
            
            
              
              <li >
                <a href="http://fccsw.web.cern.ch/fccsw/2017/05/15/version081.html">FCCSW v0.8.1</a>
              </li>
              
            
              
              <li >
                <a href="http://fccsw.web.cern.ch/fccsw/2017/03/29/version08.html">FCCSW v0.8</a>
              </li>
              
            
            <li ><a href="http://fccsw.web.cern.ch/fccsw/snapshot.html">Snapshot</a></li>
          </ul>
          <form class="navbar-form navbar-right">
            <div class="input-group">
            <span class="input-group-addon" id="basic-addon1"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></span>
            <input type="text" class="form-control" id="search-input" placeholder="Search" aria-describedby="basic-addon1">
            </div>
          </form>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

</header>
<div class="container">
  <div class="collapse panel panel-default" id="resultswrap">
      <div class="panel-heading">Search Results <button type="button" class="close" aria-label="Close"><span aria-hidden="true" onclick="$('#resultswrap').collapse('hide');">&times;</span></button></div>
      <ul id="searchresults" class="list-group">
      </ul>
  </div>
</div>

    
    
    <div class="container">
      <div class="col-md-10">
        <h1 id="testing-in-fccsw--gaudi">Testing in FCCSW / Gaudi</h1>

<p>The Gaudi testing infrastructure is based on CTest and QMTest. This document is meant as a short overview on how to use the CTest facilities in FCCSW.</p>

<p>Some additional / orthogonal information may be found on the <a href="https://twiki.cern.ch/twiki/bin/view/Gaudi/GaudiTestingInfrastructure">Gaudi Test TWiki</a>.</p>

<h2 id="folder-structure">Folder structure</h2>

<p>We assume that in your package you have a folder structure like this:</p>

<ul>
  <li>options</li>
  <li>tests
    <ul>
      <li>options : Gaudi python configurations</li>
      <li>scripts : python scripts</li>
    </ul>
  </li>
</ul>

<p><strong>options</strong>
  Your normal python configurations for normal Gaudi jobs within your package.</p>

<p><strong>tests/options</strong>
  Your Gaudi python configurations that are only used in tests.</p>

<p><strong>tests/scripts</strong>
  Any python script that checks e.g. job output</p>

<h2 id="testing-configurations">Testing configurations</h2>

<p>Testing whether a configuration does not fail (or does fail) can be done by adding a test with <code class="highlighter-rouge">gaudi_add_test</code> in your package <code class="highlighter-rouge">CMakeLists.txt</code>:</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nf">gaudi_add_test</span><span class="p">(</span>&lt;name&gt;
               [FRAMEWORK options1 options2]
               [WORKING_DIRECTORY dir]
               [ENVIRONMENT variable[+]=value ...]
               [DEPENDS other_test ...]
               [FAILS] [PASSREGEX regex] [FAILREGEX regex]
               [TIMEOUT seconds]
               [LABELS label1 label2 ...]<span class="p">)</span>
</code></pre>
</div>

<p>Declare a run-time test in the subdirectory. <code class="highlighter-rouge">FRAMEWORK</code> - run a job with the specified options, e.g. <code class="highlighter-rouge">FRAMEWORK test/options/myexample.py</code>.</p>

<p>If special environment settings are needed, they can be specified in the section <code class="highlighter-rouge">ENVIRONMENT</code> as <code class="highlighter-rouge">&lt;var&gt;=&lt;value&gt;</code> or <code class="highlighter-rouge">&lt;var&gt;+=&lt;value&gt;</code>, where the second format
prepends the value to the PATH-like variable.</p>

<p>The <code class="highlighter-rouge">WORKING_DIRECTORY</code> option can be passed if the command needs to be run from a fixed directory (ignored by QMTEST tests). This should be used if the job needs paths that are relative. By default jobs are run from the build directory.</p>

<p>Great flexibility is given by the following options:</p>

<ul>
  <li><code class="highlighter-rouge">FAILS</code> - the tests succeds if the command fails (return code !=0)</li>
  <li><code class="highlighter-rouge">DEPENDS</code> - ensures an order of execution of tests (e.g. do not run a read test if the write one failed)</li>
  <li><code class="highlighter-rouge">PASSREGEX</code> - Specify a regexp; if matched in the output the test is successful</li>
  <li><code class="highlighter-rouge">FAILREGEX</code> - Specify a regexp; if matched in the output the test is failed</li>
  <li><code class="highlighter-rouge">LABELS</code> - list of labels to add to the test (for categorization)</li>
</ul>

<h2 id="defining-a-test-with-generic-applications">Defining a test with generic applications</h2>

<p>CTest also allows to run any other command as a test, e.g. python or compiled standalone macros. This allows to use assertions to ensure whether some output is according to specifications. Obviously, if for example the output of a Gaudi / FCCSW job should be checked, the test should depend on that test (declared with <code class="highlighter-rouge">DEPENDS</code>).</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nf">gaudi_add_test</span><span class="p">(</span>&lt;name&gt;
               [COMMAND cmd args]
               [WORKING_DIRECTORY dir]
               [ENVIRONMENT variable[+]=value ...]
               [DEPENDS other_test ...]
               [FAILS] [PASSREGEX regex] [FAILREGEX regex]
               [TIMEOUT seconds]
               [LABELS label1 label2 ...]<span class="p">)</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">COMMAND cmd args</code> allows to add any executable command, e.g. <code class="highlighter-rouge">COMMAND python myscript.py</code>.</p>

<h2 id="example">Example</h2>

<p>This example and more can be found within the <code class="highlighter-rouge">Examples</code> folder.</p>

<p>First run a configuration that generates some output <code class="highlighter-rouge">output.root</code> which we add as a first test:</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nf">gaudi_add_test</span><span class="p">(</span>DummyGen
               WORKING_DIRECTORY <span class="si">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="si">}</span>/Examples/tests <span class="c1">#so we know where the output is</span>
               FRAMEWORK tests/options/examplejob.py<span class="p">)</span>
</code></pre>
</div>

<p>Then we have a python script that checks the size of a collection:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">ROOT</span>

<span class="n">rfile</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"./output.root"</span><span class="p">,</span> <span class="s">"READ"</span><span class="p">)</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"events"</span><span class="p">)</span>

<span class="k">assert</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
</code></pre>
</div>

<p>Which we add to the CMakeLists as the second test:</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nf">gaudi_add_test</span><span class="p">(</span>DummyGenCheck
               WORKING_DIRECTORY <span class="si">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="si">}</span>/Examples/tests  <span class="c1"># so we know where to get output</span>
               COMMAND python ./scripts/dummy_gen_test.py
               DEPENDS DummyGen<span class="p">)</span>                                       <span class="c1"># as we need the output</span>
</code></pre>
</div>

<h2 id="running-tests">Running tests</h2>

<p>All tests defined in the project can be run with</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  make <span class="nb">test</span>
</code></pre>
</div>

<p>Any commandline option for cmake can be passed through the Makefile. This allows, for example, to exclude tests or only run a sub-set of tests:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  make <span class="nb">test </span><span class="nv">ARGS</span><span class="o">=</span><span class="s2">"-E Example"</span> <span class="c"># Skip any test that contains Example in it's name</span>
  make <span class="nb">test </span><span class="nv">ARGS</span><span class="o">=</span><span class="s2">"-R Example"</span> <span class="c"># Only run tests that contain Example in their names</span>
</code></pre>
</div>

<p>If tests fail, they do so silently by default. You can activate the output by setting the environment variable <code class="highlighter-rouge">CTEST_OUTPUT_ON_FAILURE</code> or do:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  make <span class="nb">test </span><span class="nv">ARGS</span><span class="o">=</span><span class="s2">"--output-on-failure"</span>
</code></pre>
</div>

      </div>
      <div class="col-md-2">    <ul class="list-group">
        <li class="list-group-header">
            <h4>External links</h4>
        </li>
        
            <li class="list-group-item">
                <a href='http://cern.ch/simba3/SelfSubscription.aspx?groupName=fcc-experiments-sw-dev'>FCCSW Mailing list</a>
            </li>
        
            <li class="list-group-item">
                <a href='http://fccsw.web.cern.ch/fccsw/tutorials/'>FCCSW Tutorials</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/fccsw/issues'>FCCSW Issue Tracker</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/'>FCCSW on GitHub</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://phsft-jenkins.cern.ch/view/FCC/'>FCCSW Jenkins</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/FCCSW/blob/master/doc/CppCodingStyleGuidelines.md'>FCCSW C++ Style Guide</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/FCCSW/blob/master/doc/GeneralCppGuidelines.md'>General C++ Guidelines</a>
            </li>
        
    </ul>
</div>
    </div>
    <script src="http://fccsw.web.cern.ch/fccsw/node_modules/jquery/dist/jquery.min.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/bootstrap-sass/assets/javascripts/bootstrap.min.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/requirejs/require.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/simple-jekyll-search/dest/simple-jekyll-search.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/javascript">
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('searchresults'),
        json: 'http://fccsw.web.cern.ch/fccsw/search.json',
        searchResultTemplate: '<li class="list-group-item"><a href="{url}" title="{desc}">{title}</a></li>',
        noResultsText: '<li class="list-group-item">No results found</li>',
        limit: 10,
        fuzzy: false,
        exclude: ['Welcome']
      });
      $("#search-input").keypress(function() {
            $("#resultswrap").collapse('show');
      });
      $("#search-input").keyup(function() {
            if ($(this).val() == "") {
                $("#resultswrap").collapse('hide');
            }
      });
      $("table").each(function(index) {
        $(this).addClass("table");
      });
    </script>


  </body>
</html>
