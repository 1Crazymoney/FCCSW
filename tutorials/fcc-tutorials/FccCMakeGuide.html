<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Fcc CMake Guide</title>
  <meta name="description" content="Main page for documentation and resources.">

  <link rel="stylesheet" href="http://fccsw.web.cern.ch/fccsw/css/main.css">
  <link rel="canonical" href="http://fccsw.web.cern.ch/fccsw/tutorials/fcc-tutorials/FccCMakeGuide.html">
  <link rel="alternate" type="application/rss+xml" title="FCCSW" href="http://fccsw.web.cern.ch/fccsw/feed.xml">
</head>


  <body>

    
<header>
   <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://fccsw.web.cern.ch/fccsw/index.html">FCCSW</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="http://fccsw.web.cern.ch/fccsw/index.html">Home</a></li>
            <li  class="active" ><a href="http://fccsw.web.cern.ch/fccsw/tutorials">Tutorials</a></li>
            <li><a>Latest Releases:</a></li>
            
            
              
              <li >
                <a href="http://fccsw.web.cern.ch/fccsw/2017/05/15/version081.html">FCCSW v0.8.1</a>
              </li>
              
            
              
              <li >
                <a href="http://fccsw.web.cern.ch/fccsw/2017/03/29/version08.html">FCCSW v0.8</a>
              </li>
              
            
            <li ><a href="http://fccsw.web.cern.ch/fccsw/snapshot.html">Snapshot</a></li>
          </ul>
          <form class="navbar-form navbar-right">
            <div class="input-group">
            <span class="input-group-addon" id="basic-addon1"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></span>
            <input type="text" class="form-control" id="search-input" placeholder="Search" aria-describedby="basic-addon1">
            </div>
          </form>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

</header>
<div class="container">
  <div class="collapse panel panel-default" id="resultswrap">
      <div class="panel-heading">Search Results <button type="button" class="close" aria-label="Close"><span aria-hidden="true" onclick="$('#resultswrap').collapse('hide');">&times;</span></button></div>
      <ul id="searchresults" class="list-group">
      </ul>
  </div>
</div>

    
    
    <div class="container">
      <div class="col-md-10">
        <h1 id="cmake-guide-for-the-fcc-software">CMake guide for the FCC software</h1>

<ul>
  <li><a href="#cmake-guide-for-the-fcc-software">CMake guide for the FCC
software</a>
    <ul>
      <li><a href="#overview">Overview</a></li>
      <li><a href="#quick-start-into-building-fccsw">Quick start into building FCCSW</a></li>
      <li><a href="#cmake-example-packages">CMake example packages</a></li>
      <li><a href="#cmake-in-the-fcc-software-framew">CMake in the FCC software
framework</a>
        <ul>
          <li><a href="#using-an-internal-library">Using an internal library</a></li>
          <li><a href="#building-a-new-gaudi-module">Building a new Gaudi module</a></li>
          <li><a href="#using-an-external-library">Using an external library</a></li>
          <li><a href="#customizing-how-cmke-is-run">Customizing how CMake is run</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="overview">Overview</h2>

<p>CMake is a tool for building software, which has become the de-facto
standard outside HEP. In HEP, it is for example used by the ILC/CLIC
communities and by the LHCb collaboration. For CMS people, CMake is the
equivalent of scram. In FCCSW, CMake is used mainly via Gaudi macros, which are however fairly similar to plain CMake commands in syntax.</p>

<p>This <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/GaudiCMakeConfiguration">LHCb Twiki</a> has some additional information on
various Gaudi CMake functions.</p>

<h2 id="quick-start-into-building-fccsw">Quick start into building FCCSW</h2>

<ul>
  <li>The software can be compiled in the root directory with <code class="highlighter-rouge">make -j8</code>.</li>
  <li>After adding new files, do <code class="highlighter-rouge">make configure</code></li>
  <li>Building single packages: <code class="highlighter-rouge">make packagename</code></li>
  <li>Cleaning up (rebuild from scratch): <code class="highlighter-rouge">make purge</code></li>
  <li>To change the build-type (e.g. Release or Debug), set the <code class="highlighter-rouge">BUILDTYPE</code> variable (e.g. <code class="highlighter-rouge">BUILDTYPE=Debug make</code>)</li>
</ul>

<h2 id="cmake-example-packages">CMake example packages</h2>

<p>Colin provides <a href="https://github.com/cbernet/cmake-examples">a few simple CMake
examples</a> independent from
the FCC software framework. They are helpful to understand the basics of
CMake.</p>

<p>Get these packages:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/cbernet/cmake-examples.git
cd cmake-examples
</code></pre>
</div>

<p>Follow the instructions in
<a href="https://github.com/cbernet/cmake-examples/blob/master/README.md">README.md</a>.</p>

<h2 id="cmake-in-the-fcc-software-framework">CMake in the FCC software framework</h2>

<p>The FCC software framework is split into single packages <code class="highlighter-rouge">Generation</code>, <code class="highlighter-rouge">Examples</code>, <code class="highlighter-rouge">Simulation</code> , …. Each of these packages contains
the file <code class="highlighter-rouge">CMakeLists.txt</code>, defining its content. To build the entire
SW, a Makefile is provided in the top level directory, so <code class="highlighter-rouge">make</code> can be invoked there to build FCCSW. To rebuild a single package
<code class="highlighter-rouge">make packagename</code> is sufficient.</p>

<p>When adding new source files to a package, the CMake build system needs
to be made aware of them. Usually <code class="highlighter-rouge">CMakeLists.txt</code> contains a wildcard
expression that adds all implementation files in a subfolder, e.g.
<code class="highlighter-rouge">src/*.cpp</code> , so there is no need to explicitly add the names of the
new files. To update the list of files, it is fastest to run
<code class="highlighter-rouge">make configure</code> .</p>

<p>Note that when changing the name of a property of an algorithm or a
tool, <code class="highlighter-rouge">make</code> (and not only <code class="highlighter-rouge">make packagename</code> ) needs to be run for
Gaudi to be aware of the change.</p>

<p>The <code class="highlighter-rouge">make</code> command creates a directory <code class="highlighter-rouge">build.xxxx</code> where <code class="highlighter-rouge">xxxx</code> depends on your platform and compiler. All build files
are writtin in that directory. There are situations where you need to clean this build folder before you can
successfully build the software:</p>

<ul>
  <li>The FCCSW environment changed (version change)</li>
  <li>Fetching changes from other users or the HEP-FCC repository with deleted files</li>
</ul>

<p>In those cases you’ll need to do <code class="highlighter-rouge">make purge</code> (this target deletes the build and install directories) and rebuild the
entire software.</p>

<h3 id="ctest-in-fccsw">CTest in FCCSW</h3>

<p>FCCSW also uses the cmake for integration tests.
This is described in detail in the documentation page on <a href="../FCCSW/doc/AddingTestsToFCCSW.html">adding tests to FCCSW</a>.</p>

<h3 id="using-an-internal-library">Using an internal library</h3>

<p>Libraries are the main tool to avoid code duplication, i.e. make pieces of code available in other parts of the framework.
Once Gaudi is notified that a certain subdirectory is needed by invoking <code class="highlighter-rouge">gaudi_depends_on_subdir</code>, internal libraries defined in this subdirectory can be used by simply adding them to the list of <code class="highlighter-rouge">INCLUDE_DIRS</code> and <code class="highlighter-rouge">LINK_LIBRARIES</code>. An example would be the way the internal library <code class="highlighter-rouge">DetCommon</code> is used by the module  <a href="https://github.com/HEP-FCC/FCCSW/blob/master/Test/TestGeometry/CMakeLists.txt"><code class="highlighter-rouge">Test/TestGeometryPlugins</code></a>  in FCCSW.
The required changes to use the <code class="highlighter-rouge">DetCommon</code> library are
* declare the dependency on the subdirectory <code class="highlighter-rouge">Detector/DetCommon</code>
* add the <code class="highlighter-rouge">DetCommon</code> headers by adding <code class="highlighter-rouge">DetCommon</code> to the <code class="highlighter-rouge">INCLUDE_DIRS</code> line
* link the <code class="highlighter-rouge">DetCommon</code> libraries by adding <code class="highlighter-rouge">DetCommon</code> to the <code class="highlighter-rouge">LINK_LIBRARIES</code> line.</p>

<h3 id="building-a-new-gaudi-module">Building a new Gaudi module</h3>

<p>A more general introduction to Gaudi modules and the differences with respect to libraries can be found in the <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/GaudiCMakeConfiguration#Building_a_Module_AKA_component">LHCb twiki</a>.
The best way is to look at existing modules in FCCSW for inspiration. The syntax to declare the module <a href="https://github.com/HEP-FCC/FCCSW/blob/master/Test/TestGeometry/CMakeLists.txt"><code class="highlighter-rouge">TestGeometryPlugins</code></a>, for example, is:</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nf">gaudi_add_module</span><span class="p">(</span>TestGeometryPlugins
                 src/components/*.cpp
                 INCLUDE_DIRS Geant4 FWCore SimG4Interface SimG4Common DetInterface DetCommon TestGeometry
                 LINK_LIBRARIES GaudiKernel FWCore Geant4 DetCommon TestGeometry<span class="p">)</span>

</code></pre>
</div>

<h3 id="using-an-external-library">Using an external library</h3>

<p>This can be done using the standard cmake command <a href="https://cmake.org/cmake/help/v3.0/command/find_package.html">find_package</a>. See <a href="https://github.com/cbernet/cmake-examples">Colins CMake examples</a> for details.</p>

<p>Sometimes external libraries require special treatment, and their documentation needs to be consulted. One known case is DD4hep, for which in some cases the CMake variable <code class="highlighter-rouge">${DD4hep_COMPONENT_LIBRARIES}</code> needs to be used in the <code class="highlighter-rouge">LINK_LIBRARIES</code> line (if the DDRec or DDSegmentation package is used). Example:</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nf">gaudi_add_library</span><span class="p">(</span>DetCommon
                 src/*.cpp
                 INCLUDE_DIRS DD4hep ROOT Geant4 DetSegmentation
                 LINK_LIBRARIES GaudiKernel DD4hep ROOT Geant4 DetSegmentation <span class="si">${</span><span class="nv">DD4hep_COMPONENT_LIBRARIES</span><span class="si">}</span>
                 PUBLIC_HEADERS DetCommon<span class="p">)</span>

</code></pre>
</div>

<p>ROOT is needed in many modules of FCCSW. More information how to use it in a CMake-based project is available on the <a href="https://root.cern.ch/how/integrate-root-my-project-cmake">ROOT website</a>.</p>

<h3 id="customizing-how-cmake-is-run">Customizing how CMake is run</h3>

<p>An environment variable is used to forward command line arguments to the cmake command, for example to run cmake with the <code class="highlighter-rouge">trace</code> option:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CMAKEFLAGS='--trace' make
</code></pre>
</div>

      </div>
      <div class="col-md-2">    <ul class="list-group">
        <li class="list-group-header">
            <h4>External links</h4>
        </li>
        
            <li class="list-group-item">
                <a href='http://cern.ch/simba3/SelfSubscription.aspx?groupName=fcc-experiments-sw-dev'>FCCSW Mailing list</a>
            </li>
        
            <li class="list-group-item">
                <a href='http://fccsw.web.cern.ch/fccsw/tutorials/'>FCCSW Tutorials</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/fccsw/issues'>FCCSW Issue Tracker</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/'>FCCSW on GitHub</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://phsft-jenkins.cern.ch/view/FCC/'>FCCSW Jenkins</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/FCCSW/blob/master/doc/CppCodingStyleGuidelines.md'>FCCSW C++ Style Guide</a>
            </li>
        
            <li class="list-group-item">
                <a href='https://github.com/HEP-FCC/FCCSW/blob/master/doc/GeneralCppGuidelines.md'>General C++ Guidelines</a>
            </li>
        
    </ul>
</div>
    </div>
    <script src="http://fccsw.web.cern.ch/fccsw/node_modules/jquery/dist/jquery.min.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/bootstrap-sass/assets/javascripts/bootstrap.min.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/requirejs/require.js" type="text/javascript"></script>
<script src="http://fccsw.web.cern.ch/fccsw/node_modules/simple-jekyll-search/dest/simple-jekyll-search.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/javascript">
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('searchresults'),
        json: 'http://fccsw.web.cern.ch/fccsw/search.json',
        searchResultTemplate: '<li class="list-group-item"><a href="{url}" title="{desc}">{title}</a></li>',
        noResultsText: '<li class="list-group-item">No results found</li>',
        limit: 10,
        fuzzy: false,
        exclude: ['Welcome']
      });
      $("#search-input").keypress(function() {
            $("#resultswrap").collapse('show');
      });
      $("#search-input").keyup(function() {
            if ($(this).val() == "") {
                $("#resultswrap").collapse('hide');
            }
      });
      $("table").each(function(index) {
        $(this).addClass("table");
      });
    </script>


  </body>
</html>
